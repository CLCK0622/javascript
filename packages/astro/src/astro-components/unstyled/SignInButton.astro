---
import type { SignInButtonProps } from '@clerk/types';
import type { AsChildProps } from '../../types';
import { addUnstyledAttributeToFirstTag } from './utils';
import { generateSafeId } from '@clerk/astro/internal';

type Props = AsChildProps<SignInButtonProps>;

const safeId = generateSafeId();

const {
  asChild,
  forceRedirectUrl,
  fallbackRedirectUrl,
  signUpFallbackRedirectUrl,
  signUpForceRedirectUrl,
  mode,
  ...props
} = Astro.props

const signInOptions = {
  forceRedirectUrl,
  fallbackRedirectUrl,
  signUpFallbackRedirectUrl,
  signUpForceRedirectUrl,
};

let htmlElement = ''

if (asChild) {
  htmlElement = await Astro.slots.render('default')
  htmlElement = addUnstyledAttributeToFirstTag(htmlElement, safeId)
}
---

{
  asChild ? (
    <Fragment set:html={htmlElement} />
  ) : (
    <button {...props} data-clerk-unstyled-id={safeId}>
      <slot>Sign in</slot>
    </button >
  )
}

<script is:inline define:vars={{ props, signInOptions, mode, safeId }}>
  const btn = document.querySelector(`[data-clerk-unstyled-id="${safeId}"]`);

  btn.addEventListener("click", () => {
    const clerk = window.Clerk

    if (mode === 'modal') {
      return clerk.openSignIn({ ...signInOptions, appearance: props.appearance });
    }

    return clerk.redirectToSignIn({
      ...signInOptions,
      signInFallbackRedirectUrl: signInOptions.fallbackRedirectUrl,
      signInForceRedirectUrl: signInOptions.forceRedirectUrl,
    });
  });
</script>
